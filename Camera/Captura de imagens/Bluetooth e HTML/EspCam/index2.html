<!DOCTYPE html>
<html>
<head>
  <title>ESP32-CAM BLE Interface</title>
</head>
<body>
  <h1>ESP32-CAM BLE Interface</h1>
  <button id="connect">Conectar à ESP32-CAM</button>
  <button id="capture">Capturar Imagem</button>
  <div id="output"></div>
  
  <script>
    let esp32Device;
    let enviarImagemCharacteristic;
    let receberIntCharacteristic;

    document.getElementById('connect').addEventListener('click', async () => {
      try {
        console.log('Solicitando dispositivo BLE...');
        esp32Device = await navigator.bluetooth.requestDevice({
          filters: [{ name: 'ESP32-CAM' }],
          optionalServices: ['19B10000-E8F2-537E-4F6C-D104768A1213']
        });
        
        console.log('Conectando ao GATT Server...');
        const server = await esp32Device.gatt.connect();
        
        console.log('Obtendo serviço...');
        const service = await server.getPrimaryService('19B10000-E8F2-537E-4F6C-D104768A1213');
        
        console.log('Obtendo característica enviarImagem...');
        enviarImagemCharacteristic = await service.getCharacteristic('19B10000-E8F2-537E-4F6C-D104768A1214');
        
        console.log('Obtendo característica receberInt...');
        receberIntCharacteristic = await service.getCharacteristic('19B10000-E8F2-537E-4F6C-D104768A1215');
        
        console.log('Conectado com sucesso!');
      } catch (error) {
        console.log('Erro: ' + error);
      }
    });

    document.getElementById('capture').addEventListener('click', async () => {
      if (!receberIntCharacteristic) {
        console.log('Não conectado ao dispositivo');
        return;
      }

      try {
        console.log('Enviando comando para capturar imagem...');
        await receberIntCharacteristic.writeValue(Uint8Array.of(1));
        
        console.log('Recebendo dados da imagem...');
        receberImagem();
      } catch (error) {
        console.log('Erro: ' + error);
      }
    });

    async function receberImagem() {
      if (!enviarImagemCharacteristic) {
        console.log('Não conectado ao dispositivo');
        return;
      }

      try {
        let imageData = [];
        enviarImagemCharacteristic.addEventListener('characteristicvaluechanged', (event) => {
          const value = new Uint8Array(event.target.value.buffer);
          imageData.push(...value);

          console.log('Dados recebidos: ', value);
        });

        await enviarImagemCharacteristic.startNotifications();
        console.log('Recebendo dados...');
      } catch (error) {
        console.log('Erro: ' + error);
      }
    }
  </script>
</body>
</html>
